/* Autogenerated with kurento-module-creator */

#include <gst/gst.h>
#include "MediaPipeline.hpp"
#include "MediaProfileSpecType.hpp"
#include "RecorderEndpointImpl.hpp"
#include "RecorderEndpointImplFactory.hpp"
#include "RecorderEndpointInternal.hpp"
#include <jsonrpc/JsonSerializer.hpp>
#include <KurentoException.hpp>

using kurento::KurentoException;

namespace kurento
{

MediaObjectImpl *RecorderEndpointImplFactory::createObjectPointer (const boost::property_tree::ptree &conf, const Json::Value &params) const
{
  kurento::JsonSerializer s (false);
  RecorderEndpointConstructor constructor;

  s.JsonValue = params;
  constructor.Serialize (s);

  return createObject (conf, constructor.getMediaPipeline(), constructor.getUri(), constructor.getMediaProfile(), constructor.getStopOnEndOfStream() );
}

void
RecorderEndpointImpl::invoke (std::shared_ptr<MediaObjectImpl> obj, const std::string &methodName, const Json::Value &params, Json::Value &response)
{
  if (methodName == "record") {
    kurento::JsonSerializer s (false);
    RecorderEndpointMethodRecord method;

    s.JsonValue = params;
    method.Serialize (s);

    method.invoke (std::dynamic_pointer_cast<RecorderEndpoint> (obj) );
    return;
  }

  if (methodName == "stopAndWait") {
    kurento::JsonSerializer s (false);
    RecorderEndpointMethodStopAndWait method;

    s.JsonValue = params;
    method.Serialize (s);

    method.invoke (std::dynamic_pointer_cast<RecorderEndpoint> (obj) );
    return;
  }

  UriEndpointImpl::invoke (obj, methodName, params, response);
}

bool
RecorderEndpointImpl::connect (const std::string &eventType, std::shared_ptr<EventHandler> handler)
{

  if ("Recording" == eventType) {
    std::weak_ptr<EventHandler> wh = handler;

    sigc::connection conn = signalRecording.connect ([ &, wh] (Recording event) {
      std::shared_ptr<EventHandler> lh = wh.lock();
      if (!lh)
        return;

      std::shared_ptr<Recording> ev_ref (new Recording(event));
      auto object = this->shared_from_this();

      lh->sendEventAsync ([ev_ref, object, lh] {
        JsonSerializer s (true);

        s.Serialize ("data", ev_ref.get());
        s.Serialize ("object", object.get());
        s.JsonValue["type"] = "Recording";

        lh->sendEvent (s.JsonValue);
      });
    });
    handler->setConnection (conn);
    return true;
  }

  if ("Paused" == eventType) {
    std::weak_ptr<EventHandler> wh = handler;

    sigc::connection conn = signalPaused.connect ([ &, wh] (Paused event) {
      std::shared_ptr<EventHandler> lh = wh.lock();
      if (!lh)
        return;

      std::shared_ptr<Paused> ev_ref (new Paused(event));
      auto object = this->shared_from_this();

      lh->sendEventAsync ([ev_ref, object, lh] {
        JsonSerializer s (true);

        s.Serialize ("data", ev_ref.get());
        s.Serialize ("object", object.get());
        s.JsonValue["type"] = "Paused";

        lh->sendEvent (s.JsonValue);
      });
    });
    handler->setConnection (conn);
    return true;
  }

  if ("Stopped" == eventType) {
    std::weak_ptr<EventHandler> wh = handler;

    sigc::connection conn = signalStopped.connect ([ &, wh] (Stopped event) {
      std::shared_ptr<EventHandler> lh = wh.lock();
      if (!lh)
        return;

      std::shared_ptr<Stopped> ev_ref (new Stopped(event));
      auto object = this->shared_from_this();

      lh->sendEventAsync ([ev_ref, object, lh] {
        JsonSerializer s (true);

        s.Serialize ("data", ev_ref.get());
        s.Serialize ("object", object.get());
        s.JsonValue["type"] = "Stopped";

        lh->sendEvent (s.JsonValue);
      });
    });
    handler->setConnection (conn);
    return true;
  }

  return UriEndpointImpl::connect (eventType, handler);
}

void
RecorderEndpointImpl::Serialize (JsonSerializer &serializer)
{
  if (serializer.IsWriter) {
    try {
      Json::Value v (getId() );

      serializer.JsonValue = v;
    } catch (std::bad_cast &e) {
    }
  } else {
    throw KurentoException (MARSHALL_ERROR,
                            "'RecorderEndpointImpl' cannot be deserialized as an object");
  }
}
} /* kurento */

namespace kurento
{

void
Serialize (std::shared_ptr<kurento::RecorderEndpointImpl> &object, JsonSerializer &serializer)
{
  if (serializer.IsWriter) {
    if (object) {
      object->Serialize (serializer);
    }
  } else {
    std::shared_ptr<kurento::MediaObjectImpl> aux;
    aux = kurento::RecorderEndpointImplFactory::getObject (JsonFixes::getString(serializer.JsonValue) );
    object = std::dynamic_pointer_cast<kurento::RecorderEndpointImpl> (aux);
  }
}

void
Serialize (std::shared_ptr<kurento::RecorderEndpoint> &object, JsonSerializer &serializer)
{
  std::shared_ptr<kurento::RecorderEndpointImpl> aux = std::dynamic_pointer_cast<kurento::RecorderEndpointImpl> (object);

  Serialize (aux, serializer);
  object = std::dynamic_pointer_cast <kurento::RecorderEndpoint> (aux);
}

} /* kurento */